{
  "admin": {
    "disabled": false,
    "listen": "0.0.0.0:2019"
  },
  "apps": {
    "http": {
      "servers": {
        "wc_server": {
          "listen": [":443"],
          "routes": [
            {
              "@id": "{env.PROXY_NETWORK_DOMAIN}",
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "@id": "S_{env.PROXY_STORAGE_NETWORK_DOMAIN}",
                      "handle": [
                        {
                          "handler": "subroute",
                          "routes": [
                            {
                              "handle": [
                                {
                                  "handler": "headers",
                                  "response": {
                                    "set": {
                                      "Server": ["EDJX"],
                                      "Access-Control-Allow-Origin": ["*"]
                                    }
                                  }
                                },
                                {
                                  "handler": "geoip"
                                },
                                {
                                  "handler": "subroute",
                                  "routes": [
                                    {
                                      "match": [
                                        {
                                          "expression": "size({edjgeohash})>0"
                                        }
                                      ],
                                      "handle": [
                                        {
                                          "handler": "static_response",
                                          "headers": {
                                            "Location": [
                                              "{http.request.scheme}://{edjresource}{edjseparator}{edjgeohash}.{edjdomain}{http.request.uri}"
                                            ]
                                          },
                                          "status_code": 307
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "handler": "session_validator"
                                },
                                {
                                  "handler": "rewrite",
                                  "uri_substring": [
                                    {
                                      "find": "blobs",
                                      "replace": "api/v1/blobs",
                                      "limit": 1
                                    }
                                  ]
                                },
                                {
                                  "handler": "reverse_proxy",
                                  "upstreams": [
                                    {
                                      "dial": "localhost:8085"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ],
                      "match": [
                        {
                          "host": [
                            "{env.PROXY_STORAGE_NETWORK_DOMAIN}",
                            "*.{env.PROXY_STORAGE_NETWORK_DOMAIN}",
                            "*.*.{env.PROXY_STORAGE_NETWORK_DOMAIN}",
                            "*.*.*.{env.PROXY_STORAGE_NETWORK_DOMAIN}"
                          ]
                        }
                      ],
                      "terminal": true
                    },
                    {
                      "@id": "S_{env.PROXY_FN_NETWORK_DOMAIN}",
                      "handle": [
                        {
                          "handler": "subroute",
                          "routes": [
                            {
                              "handle": [
                                {
                                  "handler": "headers",
                                  "response": {
                                    "set": {
                                      "Server": ["EDJX"],
                                      "Access-Control-Allow-Origin": ["*"]
                                    }
                                  }
                                },
                                {
                                  "handler": "geoip"
                                },
                                {
                                  "handler": "subroute",
                                  "routes": [
                                    {
                                      "match": [
                                        {
                                          "expression": "size({edjgeohash})>0"
                                        }
                                      ],
                                      "handle": [
                                        {
                                          "handler": "static_response",
                                          "headers": {
                                            "Location": [
                                              "{http.request.scheme}://{edjresource}{edjseparator}{edjgeohash}.{edjdomain}{http.request.uri}"
                                            ]
                                          },
                                          "status_code": 307
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "handler": "session_validator"
                                },
                                {
                                  "handler": "reverse_proxy",
                                  "upstreams": [
                                    {
                                      "dial": "localhost:3001"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ],
                      "match": [
                        {
                          "host": [
                            "{env.PROXY_FN_NETWORK_DOMAIN}",
                            "*.{env.PROXY_FN_NETWORK_DOMAIN}",
                            "*.*.{env.PROXY_FN_NETWORK_DOMAIN}",
                            "*.*.*.{env.PROXY_FN_NETWORK_DOMAIN}"
                          ]
                        }
                      ],
                      "terminal": true
                    }
                  ]
                }
              ],
              "match": [
                {
                  "host": [
                    "{env.PROXY_NETWORK_DOMAIN}",
                    "*.{env.PROXY_NETWORK_DOMAIN}",
                    "*.*.{env.PROXY_NETWORK_DOMAIN}",
                    "*.*.*.{env.PROXY_NETWORK_DOMAIN}"
                  ]
                }
              ],
              "terminal": true
            }
          ],
          "strict_sni_host": false,
          "tls_connection_policies": [
            {
              "match": {
                "sni": ["*.storage.validate.edjx.network"]
              },
              "certificate_selection": {
                "all_tags": ["storage"]
              },
              "client_authentication": {
                "mode": "request"
              }
            },
            {
              "match": {
                "sni": ["*.fn.validate.edjx.network"]
              },
              "certificate_selection": {
                "all_tags": ["fn"]
              },
              "client_authentication": {
                "mode": "request"
              }
            }
          ]
        },
        "edjproxy": {
          "listen": [":80"],
          "routes": [
            {
              "@id": "wildcard-routes",
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "match": [
                        {
                          "path": ["/config/*", "/feeds/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "headers",
                          "response": {
                            "set": {
                              "Server": ["EDJX"]
                            }
                          }
                        },
                        {
                          "handler": "reverse_proxy",
                          "upstreams": [
                            {
                              "dial": "localhost:8080"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "tls": {
      "certificates": {
        "load_files": [
          {
            "certificate": "/runtime/certificates/storage/fullchain.pem",
            "key": "/runtime/certificates/storage/privkey.pem",
            "tags": ["storage"]
          },
          {
            "certificate": "/runtime/certificates/fn/fullchain.pem",
            "key": "/runtime/certificates/fn/privkey.pem",
            "tags": ["fn"]
          }
        ]
      },
      "automation": {
        "policies": [
          {
            "on_demand": true
          }
        ]
      }
    }
  },
  "logging": {
    "logs": {
      "default": {
        "level": "DEBUG"
      }
    }
  }
}
